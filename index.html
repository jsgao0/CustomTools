<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Customtools by jsgao0</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
        <style type="text/css">
            html, body {
                margin: 0px;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            header, footer {
                display: none;
            }
            #main-content, #main-demo {
                height: 100%;
                width: 100%;
            }
            #main-demo {
                position: relative;
                top: 0;
                left: 0;
            }
            #button-zone {
                position: absolute;
                top: 10px;
                left: 10px;
            }
            #panel {
                position: absolute;
                top: 40px;
                left: 10px;
                overflow: hidden;
            }
            .panel-icons, #the-logo {
                background: url("images/TOOLS_Templates_icons.png"), transparent;
                background-repeat: no-repeat;
                background-size: 800px 590px;
            }
            .main-parts, #the-logo {
                border: 10px solid transparent;
                width: 270px;
                height: 130px;
            }
            #the-logo {
                position: absolute;
                top: 10px;
                right: 10px;
                background-position: 0 0px;
            }
            #the-single {
                background-position: 0 -150px;
            }
            #the-dobule {
                background-position: 0 -300px;
            }
            #the-plank {
                background-position: 0 -450px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1 class="project-name">Customtools</h1>
            <h2 class="project-tagline">It&#39;s only bicycle tools.</h2>
        </header>
        <section id="main-content">
            <section id="main-demo"></section>
            <div id="button-zone">
                <button id="save-stl-button" onclick="saveAsSTL()">Save As STL</button>
                <button id="save-obj-button" onclick="saveAsOBJ()">Save As Object</button>
            </div>
            <div id="panel">
                <div id="the-single" class="main-parts panel-icons" onclick="showModel('mainParts', 0)"></div>
                <div id="the-dobule" class="main-parts panel-icons" onclick="showModel('mainParts', 1)"></div>
                <div id="the-plank" class="main-parts panel-icons" onclick="showModel('mainParts', 2)"></div>
            </div> 
            <div id="the-logo" class="main-parts panel-icons"></div>
        </section>
        <footer class="site-footer">
            <span class="site-footer-owner"><a href="https://github.com/jsgao0/CustomTools">Customtools</a> is maintained by <a href="https://github.com/jsgao0">jsgao0</a>.</span>

            <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
        </footer>

        <script type="text/javascript">
            // var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            // document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
            // try {
            // var pageTracker = _gat._getTracker("UA-59178595-3");
            // pageTracker._trackPageview();
            // } catch(err) {}
        </script>

        <script type="text/javascript" src="./javascripts/three.min.js"></script>
        <script type="text/javascript" src="./javascripts/DDSLoader.js"></script>
        <script type="text/javascript" src="./javascripts/MTLLoader.js"></script>
        <script type="text/javascript" src="./javascripts/OBJMTLLoader.js"></script>
        <script type="text/javascript" src="./javascripts/OBJExporter.js"></script>
        <script type="text/javascript" src="./javascripts/STLBinaryExporter.js"></script>
        <script type="text/javascript" src="./javascripts/STLExporter.js"></script>

        <script type="text/javascript">


            var container, stats;

            var camera, scene, raycaster, renderer;

            var mouse = new THREE.Vector2(), INTERSECTED, SELECTED=null;

            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;

            var mainParts = new Array(),
                addOns = new Array(),
                cutOuts = new Array();

            var initCamera = function(positionVector) {
                // Camera
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
                camera.position.set(positionVector.x, positionVector.y, positionVector.z);
            }

            var toolkit = function() {
                var thisObject = this;
                this.loadedFileAmount = 0;
                this.mainPartPath = 'obj/';
                this.addOnPath = 'obj/Add_Ons/';
                this.cutOutPath = 'obj/Cut_Out/';
                this.mainPartNames = ['TOOLS_Templates_TypeA', 'TOOLS_Templates_TypeB', 'TOOLS_Templates_TypeC'];
                this.addOnNames = ['TOOLS_Templates_Hexagon_Add_on', 'TOOLS_Templates_SpannerHead_Add_on', 'TOOLS_Templates_TireTool_Add_on'];
                this.cutOutNames = ['TOOLS_Templates_Hexagon_Cut_Outs', 'TOOLS_Templates_Spanner_Cut_Outs', 'TOOLS_Templates_Square_Cut_Outs', 'TOOLS_Templates_TireTool_Cut_Outs'];
                this.totalFiles = this.mainPartNames.length + this.addOnNames.length + this.cutOutNames.length;
                this.isCompletedLoading = function() {
                    return thisObject.totalFiles == thisObject.loadedFileAmount;
                }
                this.getTotalFileAmount = function() {
                    thisObject.totalFiles = thisObject.mainPartNames.length + thisObject.addOnNames.length + thisObject.cutOutNames.length;
                }
                this.bindPath = function(path, fileName, fileType) {
                    return path + fileName + fileType;
                }
                this.loadObject = function(modelObject) { 
                    // Model loader.
                    THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );
                    // Model loading functions.
                    var onProgress = function ( xhr ) {
                        if ( xhr.lengthComputable ) {
                            var percentComplete = xhr.loaded / xhr.total * 100;
                            console.log( Math.round(percentComplete, 2) + '% downloaded' );
                        }
                    };
                    var onError = function ( xhr ) {
                    };
                    var loader = new THREE.OBJMTLLoader();
                    loader.load( modelObject.obj, modelObject.path, function ( object ) {

                        modelObject.model = object;
                    
                    }, onProgress, onError );
                }
                this.getObjects = function(objectNames, objectPath) {
                    return objectNames.map(function(ele) {
                        var returnObject = {obj: thisObject.bindPath(objectPath, ele, '.obj'), mtl: thisObject.bindPath(objectPath, ele, '.mtl')};
                        return returnObject;
                    });
                }
                this.mainParts = this.getObjects(thisObject.mainPartNames, thisObject.mainPartPath);
                this.addOns = this.getObjects(thisObject.addOnNames, thisObject.addOnPath);
                this.cutOuts = this.getObjects(thisObject.cutOutNames, thisObject.cutOutPath);
            }

            var toolkit;

            function showModel(whichPart, index) {
                toolkit[whichPart].forEach(function(ele) {
                    scene.remove(ele.model);
                })
                scene.add(toolkit[whichPart][index].model);
            }

            function prepareStep() {

                toolkit.mainParts.forEach(function(ele) {
                    toolkit.loadObject(ele);
                });
            
                toolkit.addOns.forEach(function(ele) {
                    toolkit.loadObject(ele);
                });

                toolkit.cutOuts.forEach(function(ele) {
                    toolkit.loadObject(ele)
                });
                
            }

            function init() {
                toolkit = new toolkit();
                prepareStep();

                initCamera(new THREE.Vector3(0, 300, 0));

                // Scene
                scene = new THREE.Scene();

                // Light
                var ambient = new THREE.AmbientLight( 0xAAAAAA );
                scene.add( ambient );
                

                // Raycaster
                raycaster = new THREE.Raycaster();

                // Rendering.
                var mainDemo = document.getElementById("main-demo");
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize(window.innerWidth, window.innerHeight);
                mainDemo.appendChild( renderer.domElement );

                // Event binding.
                renderer.domElement.addEventListener( 'mousemove', onDocumentMouseMove, false );
                renderer.domElement.addEventListener('mousedown', onDocumentMouseDown, false);
                renderer.domElement.addEventListener('mouseup', onDocumentMouseUp, false);
                window.addEventListener( 'resize', onWindowResize, false );
                
            }

            function onWindowResize(event) {

                event.preventDefault();

                windowHalfX = window.innerWidth / 2;
                windowHalfY = window.innerHeight / 2;
                renderer.setSize(window.innerWidth, window.innerHeight);

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

            }

            var getModelsFromObjectList = function(objectArray) {
                return objectArray.map(function(ele) {
                    return ele.model;
                });
            }

            function onDocumentMouseMove(event) {

                mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

                var intersects = raycaster.intersectObjects(scene.children, true);
                if ( intersects.length > 0 ) {
                    if ( INTERSECTED != intersects[ 0 ].object ) {
                        if ( INTERSECTED )  INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
                        INTERSECTED = intersects[ 0 ].object;
                        INTERSECTED.material.emissive.setHex( 0xff0000 );
                    }
                } else {
                    if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
                    INTERSECTED = null;
                    SELECTED = null
                }

            }

            function onDocumentMouseDown(event) {
                event.preventDefault();
                var intersects = raycaster.intersectObjects(scene.children, true );
                if(intersects.length > 0)  {
                    SELECTED = intersects[0].object;
                    INTERSECTED.material.emissive.setHex( 0xffff00 );
                }
 
            }

            function onDocumentMouseUp(event) {
                event.preventDefault();
                var intersects = raycaster.intersectObjects(scene.children, true );
                if(intersects.length > 0) {
                    INTERSECTED.material.emissive.setHex( 0xff0000 );
                    selectModelAtStep(SELECTED);
                } 
            }

            function animate() {

                requestAnimationFrame( animate );
                render();

            }

            var isWatchingMenu = false;

            function render() {

                camera.lookAt( new THREE.Vector3(0, 0, 0));

                raycaster.setFromCamera( mouse, camera );

                renderer.render( scene, camera );
            }

            init();
            animate();

            function generateLink(dataFormat, data) {
                var link = document.createElement('a');
                link.download = "CustomTool" + dataFormat;
                link.href = data;
                return link;
            }

            function saveAsSTL() {
                var stlExporter = new THREE.STLExporter();
                if(SELECTED) {
                    generateLink('.stl', 'data:,' + encodeURIComponent(stlExporter.parse(SELECTED))).click();
                }
            }

            function saveAsOBJ() {
                var objExporter = new THREE.OBJExporter();
                if(SELECTED) {
                    generateLink('.obj', 'data:,' + encodeURIComponent(objExporter.parse(SELECTED))).click();
                }
            }

        </script>

    </body>
</html>
